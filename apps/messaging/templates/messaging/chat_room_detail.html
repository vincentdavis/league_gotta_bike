{% extends "organizations/base.html" %}

{% block title %}{{ room.name }} - Chat{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">{{ room.name }}</h1>
                {% if room.organization %}
                <p class="text-gray-600">{{ room.organization.name }} - {{ room.get_room_type_display }}</p>
                {% else %}
                <p class="text-gray-600">{{ room.get_room_type_display }}</p>
                {% endif %}
                {% if room.description %}
                <p class="text-gray-500 text-sm mt-1">{{ room.description }}</p>
                {% endif %}
            </div>
            {% if room.organization %}
            <a href="{{ room.organization.get_absolute_url }}" class="btn btn-ghost btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back to {{ room.organization.name }}
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Chat Container -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body p-0">
            <!-- Messages Area -->
            <div id="chat-messages" class="h-96 overflow-y-auto p-6 space-y-4 bg-base-200">
                <div class="text-center text-gray-500 text-sm py-4">
                    <p>Welcome to {{ room.name }}</p>
                    <p class="text-xs mt-1">Messages will appear here</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-base-100 border-t border-base-300">
                <div class="flex gap-2">
                    <input
                        type="text"
                        id="chat-message-input"
                        class="input input-bordered flex-1"
                        placeholder="Type your message..."
                        autocomplete="off"
                    >
                    <button id="chat-message-submit" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                        Send
                    </button>
                </div>
                <div id="connection-status" class="mt-2 text-sm">
                    <span class="text-gray-500">Initializing chat...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Room Info -->
    <div class="mt-6 alert alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div>
            <h3 class="font-bold">{{ room.name }}</h3>
            <div class="text-sm">
                {% if room.room_type == 'announcement' %}
                This is an announcement channel. Only organizers can post messages.
                {% elif room.room_type == 'organization' %}
                This chat is for organization members. Messages are visible to all members.
                {% elif room.room_type == 'direct' %}
                This is a private direct message conversation.
                {% else %}
                This is a public chat room. All authenticated users can participate.
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // WebSocket chat implementation
    const roomSlug = '{{ room.slug }}';
    const messageInput = document.getElementById('chat-message-input');
    const submitButton = document.getElementById('chat-message-submit');
    const messagesDiv = document.getElementById('chat-messages');
    const statusDiv = document.getElementById('connection-status');

    // Determine WebSocket protocol (ws or wss)
    const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${wsProtocol}://${window.location.host}/ws/chat/${roomSlug}/`;

    let chatSocket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    function updateStatus(message, isConnected) {
        statusDiv.innerHTML = isConnected
            ? `<span class="text-success text-sm">✓ ${message}</span>`
            : `<span class="text-error text-sm">✗ ${message}</span>`;
    }

    function connectWebSocket() {
        updateStatus('Connecting...', false);

        chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = function(e) {
            console.log('WebSocket connection established');
            updateStatus('Connected', true);
            reconnectAttempts = 0;
            messageInput.disabled = false;
            submitButton.disabled = false;
            submitButton.classList.remove('btn-disabled');
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log('Received message:', data);

            if (data.type === 'message_history') {
                // Clear welcome message and load history
                messagesDiv.innerHTML = '';
                data.messages.forEach(msg => appendMessage(msg));
                scrollToBottom();
            } else if (data.type === 'message') {
                // New message received
                appendMessage(data.message);
                scrollToBottom();
            } else if (data.type === 'error') {
                // Error message
                showError(data.message);
            }
        };

        chatSocket.onclose = function(e) {
            console.log('WebSocket connection closed:', e.code);
            updateStatus('Disconnected', false);
            messageInput.disabled = true;
            submitButton.disabled = true;
            submitButton.classList.add('btn-disabled');

            // Attempt to reconnect
            if (reconnectAttempts < maxReconnectAttempts && e.code !== 4003 && e.code !== 4004) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                updateStatus(`Reconnecting in ${delay/1000}s... (attempt ${reconnectAttempts}/${maxReconnectAttempts})`, false);
                setTimeout(connectWebSocket, delay);
            } else if (e.code === 4003) {
                updateStatus('Access denied - You do not have permission to access this chat room', false);
            } else if (e.code === 4004) {
                updateStatus('Chat room not found', false);
            }
        };

        chatSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
            updateStatus('Connection error', false);
        };
    }

    function appendMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'chat chat-start';

        const timestamp = new Date(message.timestamp);
        const timeStr = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        messageElement.innerHTML = `
            <div class="chat-header">
                <span class="font-semibold">${escapeHtml(message.username)}</span>
                <time class="text-xs opacity-50 ml-2">${timeStr}</time>
            </div>
            <div class="chat-bubble">${escapeHtml(message.text)}</div>
        `;

        messagesDiv.appendChild(messageElement);
    }

    function showError(errorMessage) {
        const errorElement = document.createElement('div');
        errorElement.className = 'alert alert-error mb-2';
        errorElement.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>${escapeHtml(errorMessage)}</span>
        `;
        messagesDiv.appendChild(errorElement);
        scrollToBottom();

        // Remove error after 5 seconds
        setTimeout(() => errorElement.remove(), 5000);
    }

    function sendMessage() {
        const message = messageInput.value.trim();
        if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInput.value = '';
        }
    }

    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Event listeners
    submitButton.addEventListener('click', sendMessage);

    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Connect on page load
    connectWebSocket();

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (chatSocket) {
            chatSocket.close();
        }
    });
</script>
{% endblock %}
